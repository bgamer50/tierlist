<!DOCTYPE html>
<html>
	<head>
		<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
		<script type="text/javascript" src="/jquery"></script>
		<script type="text/javascript">
			window.filename = "";
			function getArguments() {
				var parameters = location.search.substring(1).split("&");

    			var temp = parameters[0].split("=");
    			window.filename = unescape(temp[1]);
    			WebSocketActivate();
			}
			function WebSocketActivate() {
            	if ("WebSocket" in window) {
                	var ws = new WebSocket("ws://localhost:8888/w?Id=123456789");
                	ws.onopen = function() {
                    	ws.send(window.filename);
                	};
                	ws.onmessage = function (evt) { 
                	    var received_msg = evt.data;
                	    console.log(received_msg);
                	    window.file = $.parseJSON(received_msg);
                	    parseData();
                	};
                	ws.onclose = function() { 
                    	return;
                	};
            	} else {
                	//WebSockets not supported by browser
                	return;
            	}
        	}
			function parseData() {
				fields = ['field1', 'field2', 'field3', 'field4', 'field5'];
				data = [];
				for(var k = 0; k < window.file.length; k++) {
					var f4 = "";
					if(k != 0)
						//f4 = "<input type=button value='+' onclick='WebSocketChangeRank(" + '"' + window.file[k][1] + '"' + "," + (-1 + window.file[k][2]) + ");'></input>";
						f4 = "<div id='promote" + window.file[k][1] + "'></div>";
					
					data.push({field1: window.file[k][0], field2: window.file[k][1], field3: window.file[k][2], field4: f4, field5: '<img src="/del" alt="Delete" height="18" width="18"'});
				}

				var f3 = window.file[window.file.length - 1][window.file[0].length - 1] + 1;
				//Create the elements
				//start with the add button
				var addbutton = document.createElement('input');
				addbutton.setAttribute('type', 'button');
				addbutton.setAttribute('value', "Add");
				addbutton.setAttribute('id', 'addbutton');

				//the text field "name box"
				var namebox = document.createElement('input');
				namebox.setAttribute('type', 'text');
				namebox.setAttribute('value', 'Enter Name');
				namebox.setAttribute('id', 'namebox');

				var f4 = "";
				data.push({field1: ".", field2: "<div id='nameboxContainer'></div>", field3: f3, field4: f4, field5: "<div id='addbuttonContainer'></div>"});
				var rows = '';
        		$.each(data, function(index, item) {
            		var row = '<tr>';
           			$.each(fields, function(index, field) {
                		row += '<td>' + item[field+''] + '</td>';
            		});
            		rows += row + '<tr>';
        		});
        		$('#' + 'listtable' + ' tbody').html(rows);

        		document.getElementById("nameboxContainer").appendChild(namebox);
        		document.getElementById("addbuttonContainer").appendChild(addbutton);
        		for(var k = 1; k < window.file.length; k++) {
        			//promote button is a temp object
					promotebutton = document.createElement('input');
					promotebutton.setAttribute('type', 'button');
					promotebutton.setAttribute('value', '+');
					var arg1 = "" + window.file[k][1];
					var arg2 = -1 + window.file[k][2];
					promotebutton.addEventListener("click", function(event) { WebSocketChangeRank(arg1, arg2); event.preventDefault(); });

					document.getElementById("promote" + window.file[k][1]).appendChild(promotebutton);
        		}
			}
			function WebSocketChangeRank(name, rank) {
            	if ("WebSocket" in window) {
                	var ws = new WebSocket("ws://localhost:8888/ww?Id=123456789");
                	ws.onopen = function() {
                		data = [window.filename, name, rank];
                    	ws.send(JSON.stringify(data));
                	};
                	ws.onmessage = function (evt) { 
                	    var received_msg = evt.data;
                	    console.log(received_msg);
                	    //update the table
                	    WebSocketActivate();
                	};
                	ws.onclose = function() { 
                    	return;
                	};
            	} else {
                	console.log("WebSockets not supported by browser.");
                	return;
            	}
        	}
        	function WebSocketAdd(image, name, rank) {
            	if ("WebSocket" in window) {
                	var ws = new WebSocket("ws://localhost:8888/x?Id=123456789");
                	ws.onopen = function() {
                		data = [window.filename, image, name, rank];
                    	ws.send(JSON.stringify(data));
                	};
                	ws.onmessage = function (evt) { 
                	    var received_msg = evt.data;
                	    console.log(received_msg);
                	    //update the table
                	    WebSocketActivate();
                	};
                	ws.onclose = function() { 
                    	return;
                	};
            	} else {
                	console.log("WebSockets not supported by browser.");
                	return;
            	}
        	}
			//window.onload = getArguments;
		</script>
		<style>
			html {
				background-color:rgb(255,100,100);
			}

			body {
				font-family:"Raleway";
				font-size:14pt;
			}

			mh {
				font-familiy:"Raleway";
				font-size:17pt;
				font-weight:bold;
			}

			h1 {
				font-family:"Raleway";
				font-size:30pt;
			}
			table.main {
				border-collapse: separate;
				border-spacing: 4em 1em;
				text-align:center;
			}
			table.main tr th thead {
				font-weight:bold;
			}
			table.main tr td tbody {
				font-weight:normal;
			}

		</style>
		<title>List View</title>
	</head>
	
	<body>
		<a href="/">Back</a><br/><br/>
		<mh>
			<script type="text/javascript">
				getArguments();
				document.write("Displaying " + window.filename + ":")
			</script>
		</mh>
		<table id="listtable" class="main">
			<tbody>
				<tr><td>N/A</td><td>N/A</td><td>1</td></tr>
			</tbody>
		</table>
		<br/>
	</body>
</html>